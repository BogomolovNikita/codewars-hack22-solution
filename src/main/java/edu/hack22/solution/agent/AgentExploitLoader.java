package edu.hack22.solution.agent;

import java.io.File;
import java.lang.management.ManagementFactory;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;

public class AgentExploitLoader {

    public static void loadAgent(String agentFilePath) throws Exception {
        //Get the pid of the current VM.
        String nameOfRunningCurrentVM = ManagementFactory.getRuntimeMXBean().getName();
        String pid = nameOfRunningCurrentVM.substring(0, nameOfRunningCurrentVM.indexOf('@'));

        File toolsJar = getToolsLibrary();

        URL toolsJarURL = toolsJar.toURI().toURL();
        ClassLoader parentClassLoader = toolsJar.getClass().getClassLoader();

        URLClassLoader child = new URLClassLoader(new URL[]{toolsJarURL}, parentClassLoader);
        //We don't use imports because it won't work on CodeWars.
        Class<?> classToUse = Class.forName("com.sun.tools.attach.VirtualMachine", true, child);

        //Methods for loading the java agent.
        Method attachVm = classToUse.getMethod("attach", String.class);
        Method loadAgent = classToUse.getMethod("loadAgent", String.class);
        Method detachVm = classToUse.getMethod("detach");
        Object virtualMachine = attachVm.invoke(null, pid);
        loadAgent.invoke(virtualMachine, agentFilePath);
        detachVm.invoke(virtualMachine);
    }

    /*
    Make sure that there is a file in your jdk tool.jar
    */

    private static File getToolsLibrary() {
        String javaHome = System.getenv("JAVA_HOME");
        String toolsPath = javaHome + "\\lib\\tools.jar";
        return new File(toolsPath);
    }
}
